<html class="x-admin-sm">  <head>    <meta charset="UTF-8">    <title>销售收银</title>    <meta name="renderer" content="webkit">    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">    <!--<meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi" />-->    <link rel="stylesheet" href="../../css/font.css">    <link rel="stylesheet" href="../../css/xadmin.css">    <script type="text/javascript" src="../../js/jquery3.2.1.min.js"></script>    <script type="text/javascript" src="../../lib/layui/layui.js" charset="utf-8"></script>    <script type="text/javascript" src="../../js/xadmin.js"></script>    <script type="text/javascript" src="../../js/cookie.js"></script>    <script type="text/javascript" src="../../js/vue.min.js"></script>    <script type="text/javascript" src="../../js/axios.min.js"></script>    <!--<script type="text/javascript" src="../../js/vue-paginate.js"></script>-->    <!-- 让IE8/9支持媒体查询，从而兼容栅格 -->    <!--[if lt IE 9]>    <script src="../../js/html5.min.js"></script>    <script src="../../js/respond.min.js"></script>    <![endif]-->  </head>  <body onload="tableCheck.init()">    <div class="x-nav" >      <span class="layui-breadcrumb">        <a href="">首页</a>        <a href="">销售管理</a>        <a>          <cite>销售收银</cite>        </a>      </span>      <a class="layui-btn layui-btn-small" style="line-height:1.6em;margin-top:3px;float:right" href="javascript:location.replace(location.href);" title="刷新">        <i class="layui-icon" style="line-height:30px">ဂ</i></a>    </div>    <div class="x-body" id="goods">      <div class="layui-row">        <div class=" layui-col-md12 x-so">          <input type="number" v-model="barcode"  placeholder="请扫描商品条码 " @change="add()" class="layui-input">          <button class="layui-btn"  @click="add()" title="添加商品"><i class="layui-icon layui-icon-add-1" ></i></button>          <input type="number" v-model="phone"  placeholder="请输入会员手机号" @change="addMember()" class="layui-input">          <button class="layui-btn" @click="addMember()" title="添加会员"><i class="layui-icon layui-icon-add-circle"></i></button>          <button class="layui-btn" @click="reset()" title="重置"><i class="layui-icon" >&#xe669;</i></button>        </div>      </div>      <xblock >        <button class="layui-btn layui-btn-danger" @click="delAll()"><i class="layui-icon"></i>批量删除</button>          <button class="layui-btn layui-btn-warm" v-show="vshow">会员ID：{{member.id}}</button>          <button class="layui-btn layui-btn-warm" v-show="vshow">会员姓名：{{member.name}}</button>          <button class="layui-btn layui-btn-warm" v-show="vshow">会员折扣：{{member.rate*100}}折</button>        <button class=" layui-btn layui-btn-warm x-right" @click="submit()">          <i class="layui-icon">&#xe657;</i>结算</button>          <span class="x-right" style="line-height:40px">折扣后：{{totalAmount}} 元</span>          <span class="x-right" style="line-height:40px">总金额：{{totalBefore}} 元、</span>        <span class="x-right" style="line-height:40px">共有数据：{{orders.length}} 条、</span>      </xblock>      <div  class="layui-layout-right" id="product_pic" style="  position:absolute;visibility: hidden;"            onmouseover="MM_showHideLayers('product_pic','big','show');"            onmouseout="MM_showHideLayers('product_pic','big','hide');">        <!--鼠标经过的时候显示的图片-->        <img class="right" id="bigpic"  style="height: 500px ;width: 370px" src="">      </div>      <table class="x-admin layui-table ">        <thead>          <tr>              <th id="all">              </th>              <th>预览</th>              <th colspan="2">条码</th>              <th>商品名称</th>              <th>商品单价</th>              <th>购买数量</th>              <th>商品总价</th>              <th>折后总价</th>              <th>操作</th>          </tr>        </thead>        <tbody id="tbody">          <tr v-for="(items,index) in orders">            <td :id="'id:'+index" style="width: 40px">              <div class=" layui-unselect layui-form-checkbox x" lay-skin="primary" :data-id="index">                <i class="layui-icon">&#xe605;</i>              </div>            </td>            <td style="width:40px " @mouseover="MM_showHideLayers('product_pic',''+urlPrefix+items.goodsByGoodsId.picture+'','show')"            @mouseout="MM_showHideLayers('product_pic',''+urlPrefix+items.goodsByGoodsId.picture+'','hide')">            <img style="height: 45px;width: 32px" :src="urlPrefix+items.goodsByGoodsId.picture">            </td>            <td>{{items.goodsByGoodsId.createTime}}</td>            <td> <img style="height: 45px;width: 100px" :src="urlPrefix+items.goodsByGoodsId.barcode"></td>            <td>{{items.goodsByGoodsId.name}}</td>            <td>{{items.goodsByGoodsId.price}}</td>            <td>{{items.goodsNum}}</td>            <td>{{items.beforeAmount}}</td>            <td>{{items.amount}}</td>            <td class="td-manage">              <a title="删除" @click="del(index)" href="javascript:;">                <i class="layui-icon">&#xe640;</i>              </a>            </td>          </tr>        </tbody>      </table>    </div>    <script>        const app = new Vue({            el: "#goods",            data: {                // Note 'isActive' is left out and will not appear in the rendered table                orders:[],                barcode:'',                phone:'',                member:{                    id:'',                    rate:1,                    name:''                },                vshow:false,                userId:'',            },            // components: {            //   'paginate':VuePaginate            // },            computed:{                totalAmount:function(){                    var i = 0;                    var totalAmount = 0;                    while (i<this.orders.length){                        this.orders[i].amount = Number((this.orders[i].beforeAmount*this.member.rate).toFixed(2));                        totalAmount = Number((totalAmount+this.orders[i].amount).toFixed(2));                        this.orders[i].memberId=this.member.id;                        i++;                    }                    return totalAmount;                },                totalBefore:function () {                    var i = 0;                    var totalBefore = 0;                    while (i<this.orders.length){                        this.orders[i].beforeAmount = Number((this.orders[i].beforeAmount).toFixed(2));                        totalBefore = Number((totalBefore+this.orders[i].beforeAmount).toFixed(2));                        i++;                    }                    return totalBefore;                }            },//自动加载            mounted() {                var user = JSON.parse(sessionStorage.getItem('current'));                this.userId=user.id;                // console.log('userId:'+user.id);                $('#all').html('<div class="layui-unselect layui-form-checkbox header x " ' +                    'lay-skin="primary"><i class="layui-icon">&#xe605;</i></div>')            },            methods:{                submit(){                    alert(JSON.stringify(this.orders));                    if (this.orders.length>0){                        axios.post(urlPrefix+'/sell?token=' + token, {                            'sellRecordsList':this.orders                        })                            .then((response) => {                                // alert(JSON.stringify(response.data))                                if (response.data.success){                                    layer.alert('结算成功',{icon:6},function f() {                                        layer.closeAll();                                        app.reset();                                        app.orders=[];                                    });                                }else {                                    layer.msg('结算失败！',{icon:5,time:1000})                                }                            }).catch((err) => {                            errHandler(err);                        });                    }                }                ,                add() {                    if (this.barcode===''){                        layer.msg('请扫描商品条码',{icon:0,time:1000})                    } else {                        axios.get(urlPrefix + '/goods/' + this.barcode + '?token=' + token, {}).then((response) => {                            var r = response.data.data;                            if (r != null) {                                if(!r.status){                                    layer.msg("此商品已下架！", {icon: 2, time: 1000})                                }else {                                    var order={                                            goodsByGoodsId:{},                                            goodsId:'',                                            gridId:'',                                            goodsNum:1,                                            beforeAmount:0.00,                                            amount:0.00,                                            status:true,                                            userId:this.userId,                                            memberId:this.member.id                                    };                                    var rate = this.member.rate;                                    order.goodsByGoodsId=r;                                    order.goodsId=r.id;                                    order.gridId=r.gridId;                                    order.amount=Number(r.price*rate.toFixed(2));                                    order.beforeAmount=Number(r.price.toFixed(2));                                    var i=0;                                    while (i<this.orders.length){                                        if (this.orders[i].goodsId===order.goodsId) {                                            if (this.orders[i].goodsNum<order.goodsByGoodsId.num){                                                this.orders[i].goodsNum++;                                                this.orders[i].amount = Number((this.orders[i].amount + order.amount).toFixed(2));                                                this.orders[i].beforeAmount = Number((this.orders[i].beforeAmount + order.beforeAmount).toFixed(2));                                                layer.msg("添加成功！", {icon: 1, time: 1000})                                            } else {                                                layer.msg("此商品库存不足！", {icon: 2, time: 1000})                                            }                                            break;                                        }                                        i++;                                    }                                    // console.log(i+' '+this.orders.length);                                    if (i===this.orders.length){                                        this.orders.push(order);                                        layer.msg("添加成功！", {icon: 1, time: 1000})                                    }                                    // alert(JSON.stringify(this.orders));                                }                            } else layer.msg("此商品不存在！", {icon: 2, time: 1000})                            this.barcode = '';                        }).catch((err) => {                            errHandler(err);                        });                    }                },                addMember() {                    if (this.phone===''){                        layer.msg('请输入会员手机号',{icon:0,time:1000})                    } else {                        axios.get(urlPrefix+'/members/phone/'+this.phone+'?token=' + token, {                        }).then((response) => {                            var r = response.data.data;                            if (r!=null){                                this.member = r;                                this.vshow = true;                            } else layer.msg("此会员不存在！",{icon:2,time:1000})                        }).catch((err) => {                            errHandler(err);                        });                    }                },                reset(){                    this.phone='';                    this.barcode='';                    this.member= {                        id:'',                        rate:1,                        name:''                    };                    this.vshow=false;                }                ,                /*用户-删除*/                del(id){                  if (id!=null){                      // alert(id);                    this.orders.pop(id);                  }                },                //批量删除                delAll () {                var data = tableCheck.getData();                // alert(JSON.stringify(data));                if (data.length!=0) {                    for(var i =0;i<data.length;i++){                        this.orders.pop(data[i]);                    }                    $('.x').removeClass('layui-form-checked');                }else  layer.msg('至少选中一项', {icon: 2});                },        }        });      layui.use('laydate', function(){        var laydate = layui.laydate;        //执行一个laydate实例        laydate.render({            elem: '#start', //指定元素            format:'yyyy-MM-dd',            done:(value)=>{                app.start = value;            }        });        //执行一个laydate实例        laydate.render({            elem: '#end', //指定元素            format:'yyyy-MM-dd',            done:(value)=>{                app.start = value;            }        });      });    </script>  </body></html>